# systemd

- [System and Service Manager](https://systemd.io/)
- [systemd](https://www.freedesktop.org/wiki/Software/systemd/)
- [systemd 中文手册 \[金步国\]](http://www.jinbuguo.com/systemd/systemd.index.html)
- [Systemd 入门教程：命令篇 - 阮一峰的网络日志](http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-commands.html)
- [Systemd 入门教程：实战篇 - 阮一峰的网络日志](http://www.ruanyifeng.com/blog/2016/03/systemd-tutorial-part-two.html)

systemd is a suite of basic building blocks for a Linux system. It provides a system and service manager that runs as PID 1 and starts the rest of the system.

```bash
❯ procs 1
 PID:▲ User │ TTY CPU MEM CPU Time │ Command
            │     [%] [%]          │
 1     root │     0.0 0.0 00:00:01 │ /usr/lib/systemd/systemd --switched-root --system --deserialize 31
```

systemd provides aggressive parallelization capabilities, uses socket and D-Bus activation for starting services, offers on-demand starting of daemons, keeps track of processes using Linux control groups, maintains mount and automount points, and implements an elaborate transactional dependency-based service control logic. systemd supports SysV and LSB init scripts and works as a replacement for sysvinit.

Other parts include a logging daemon, utilities to control basic system configuration like the hostname, date, locale, maintain a list of logged-in users and running containers and virtual machines, system accounts, runtime directories and settings, and daemons to manage simple network configuration, network time synchronization, log forwarding, and name resolution.

## Booting

systemd-boot(7)

## Concepts

##

```bash
这两种文件夹下的都是 enable 了的

# 这个文件夹下的是强制 enable 的，无法 disable
/usr/lib/systemd/system/*.target.wants/
❯ sudo systemctl status systemd-logind.service
● systemd-logind.service - User Login Management
     Loaded: loaded (/usr/lib/systemd/system/systemd-logind.service; static)

# 这个文件夹下的可以 disable
/etc/systemd/system/*.target.wants/
还有 .requires 目录下的？

# enable 一个 service 等同于：在 /etc/systemd/system/*.target.wants/ 目录下创建一个符合链接，指向 /usr/lib/systemd/system/ 里的 .service
```

## 其他

### D-Bus

- [dbus](https://freedesktop.org/wiki/Software/dbus/)

D-Bus is a message bus system that provides an easy way for inter-process communication. It consists of a daemon, which can be run both system-wide and for each user session, and a set of libraries to allow applications to use D-Bus.

## Autostart

[Desktop Application Autostart Specification](https://specifications.freedesktop.org/autostart-spec/autostart-spec-latest.html)

systemd-xdg-autostart-generator 会自动为 ~/.config/autostart /etc/xdg/autostart 里的生成 `/run/user/1000/systemd/generator.late/*.service`

```bash
❯ systemctl status --user app-clash\\x2dverge@autostart.service
● app-clash\x2dverge@autostart.service - clash-verge
     Loaded: loaded (/home/hyuuko/.config/autostart/clash-verge.desktop; generated)
     Active: active (running) since Thu 2023-05-04 10:36:53 CST; 29min ago
       Docs: man:systemd-xdg-autostart-generator(8)
   Main PID: 1472 (clash-verge)
      Tasks: 109 (limit: 18839)
     Memory: 255.2M
        CPU: 6.527s
     CGroup: /user.slice/user-1000.slice/user@1000.service/app.slice/app-clash\x2dverge@autostart.service
             ├─1472 /usr/bin/clash-verge
             └─1643 /usr/bin/clash-meta -m -d /home/hyuuko/.config/clash-verge -f /home/hyuuko/.config/clash-verge/clash-verge.yaml

❯ systemctl cat --user app-clash\\x2dverge@autostart.service
# /run/user/1000/systemd/generator.late/app-clash\x2dverge@autostart.service
# Automatically generated by systemd-xdg-autostart-generator

[Unit]
Documentation=man:systemd-xdg-autostart-generator(8)
SourcePath=/home/hyuuko/.config/autostart/clash-verge.desktop
PartOf=graphical-session.target

Description=clash-verge
After=graphical-session.target

[Service]
Type=exec
ExitType=cgroup
ExecStart=:/usr/bin/clash-verge
Restart=no
TimeoutSec=5s
Slice=app.slice


❯ systemctl status --user xdg-desktop-autostart.target
● xdg-desktop-autostart.target - Startup of XDG autostart applications
     Loaded: loaded (/usr/lib/systemd/user/xdg-desktop-autostart.target; static)
     Active: active since Thu 2023-05-04 10:36:53 CST; 31min ago
       Docs: man:systemd.special(7)

5月 04 10:36:53 archlinux systemd[895]: Reached target Startup of XDG autostart applications.
```

如果要禁用一个 system-wide entry，可以将其复制到 ~/.config/autostart 并且加上 `Hidden=true`
